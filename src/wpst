#!/bin/bash

# WPST Panel - WordPress Stack Tool
# Main executable script
# PhiÃªn báº£n: 1.0.0

set -e

# ÄÆ°á»ng dáº«n cáº¥u hÃ¬nh
WPST_DIR="/var/www/wpst-script"
SITES_DIR="/var/www/sites"
LIB_DIR="$WPST_DIR/lib"

# Load thÆ° viá»‡n
source "$LIB_DIR/common.sh"
source "$LIB_DIR/ui.sh"
source "$LIB_DIR/system.sh"
source "$LIB_DIR/sites.sh"

# Biáº¿n toÃ n cá»¥c
CURRENT_MENU="main"
SELECTED_SITE=""

# Kiá»ƒm tra quyá»n root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "WPST Panel cáº§n cháº¡y vá»›i quyá»n root. Vui lÃ²ng cháº¡y: sudo wpst"
    fi
}

# Main menu dashboard
show_main_dashboard() {
    clear
    show_header "WPST - WordPress Stack Tool"
    
    # Pháº§n Status
    echo -e "${BLUE}ğŸ“Š TRáº NG THÃI Há»† THá»NG${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Thá»‘ng kÃª website
    local site_count=$(count_sites)
    echo -e "ğŸŒ Sá»‘ lÆ°á»£ng domain: ${GREEN}$site_count${NC}"
    
    # ThÃ´ng tin há»‡ thá»‘ng (refresh má»—i 2 giÃ¢y - sáº½ implement sau)
    show_system_stats
    
    # Tráº¡ng thÃ¡i dá»‹ch vá»¥
    show_service_status
    
    echo ""
    
    # Pháº§n Menu
    echo -e "${BLUE}ğŸ“‹ MENU CHÃNH${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "1. Quáº£n lÃ½ Website"
    echo "2. Firewall / Security"
    echo "3. Cáº­p nháº­t"
    echo "4. System Admin"
    echo ""
    echo "0. ThoÃ¡t"
    echo ""
    
    read -p "Lá»±a chá»n (0-4): " choice
    
    case $choice in
        1)
            CURRENT_MENU="sites"
            show_sites_dashboard
            ;;
        2)
            CURRENT_MENU="firewall"
            show_firewall_dashboard
            ;;
        3)
            CURRENT_MENU="update"
            show_update_dashboard
            ;;
        4)
            CURRENT_MENU="admin"
            show_admin_dashboard
            ;;
        0)
            echo -e "${GREEN}Cáº£m Æ¡n báº¡n Ä‘Ã£ sá»­ dá»¥ng WPST Panel!${NC}"
            exit 0
            ;;
        *)
            warning "Lá»±a chá»n khÃ´ng há»£p lá»‡."
            sleep 1
            show_main_dashboard
            ;;
    esac
}

# Sites management dashboard
show_sites_dashboard() {
    clear
    show_header "Quáº£n lÃ½ Website"
    
    # Pháº§n Status - danh sÃ¡ch websites
    echo -e "${BLUE}ğŸŒ DANH SÃCH WEBSITE${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    list_sites_table
    
    echo ""
    echo -e "${BLUE}ğŸ“‹ MENU QUáº¢N LÃ${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Hiá»ƒn thá»‹ menu Ä‘á»™ng dá»±a trÃªn sá»‘ lÆ°á»£ng sites
    local sites=($(get_sites_list))
    if [[ ${#sites[@]} -gt 0 ]]; then
        echo "Chá»n sá»‘ Ä‘á»ƒ quáº£n lÃ½ website:"
        for i in "${!sites[@]}"; do
            echo "$((i+1)). ${sites[i]}"
        done
        echo ""
    fi
    
    echo "n. ThÃªm website má»›i"
    echo "0. Quay láº¡i dashboard chÃ­nh"
    echo "q. ThoÃ¡t"
    echo ""
    
    read -p "Lá»±a chá»n: " choice
    
    case $choice in
        [1-9]|[1-9][0-9])
            if [[ $choice -le ${#sites[@]} ]]; then
                SELECTED_SITE="${sites[$((choice-1))]}"
                show_single_site_dashboard "$SELECTED_SITE"
            else
                warning "Lá»±a chá»n khÃ´ng há»£p lá»‡."
                sleep 1
                show_sites_dashboard
            fi
            ;;
        n|N)
            add_new_site
            ;;
        0)
            CURRENT_MENU="main"
            show_main_dashboard
            ;;
        q|Q)
            echo -e "${GREEN}Cáº£m Æ¡n báº¡n Ä‘Ã£ sá»­ dá»¥ng WPST Panel!${NC}"
            exit 0
            ;;
        *)
            warning "Lá»±a chá»n khÃ´ng há»£p lá»‡."
            sleep 1
            show_sites_dashboard
            ;;
    esac
}

# Single site management dashboard
show_single_site_dashboard() {
    local domain="$1"
    
    clear
    show_header "Quáº£n lÃ½ Website: $domain"
    
    # Pháº§n Status - thÃ´ng tin chi tiáº¿t site
    echo -e "${BLUE}ğŸ“‹ THÃ”NG TIN WEBSITE${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    show_site_details "$domain"
    
    echo ""
    echo -e "${BLUE}ğŸ“‹ MENU QUáº¢N LÃ${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "1. Caddyfile"
    echo "2. CÃ i Ä‘áº·t SSL thá»§ cÃ´ng"
    echo "3. File Manager"
    echo "4. Database"
    echo "5. Backup & Restore"
    
    # Hiá»ƒn thá»‹ menu báº­t/táº¯t Ä‘á»™ng
    local site_status=$(get_site_status "$domain")
    if [[ "$site_status" == "online" ]]; then
        echo "6. Táº¯t website"
    else
        echo "6. Báº­t website"
    fi
    
    echo "7. XÃ³a website"
    echo ""
    echo "0. Quay láº¡i danh sÃ¡ch website"
    echo "q. ThoÃ¡t"
    echo ""
    
    read -p "Lá»±a chá»n: " choice
    
    case $choice in
        1)
            edit_caddyfile "$domain"
            ;;
        2)
            setup_custom_ssl "$domain"
            ;;
        3)
            open_file_manager "$domain"
            ;;
        4)
            manage_database "$domain"
            ;;
        5)
            backup_restore_site "$domain"
            ;;
        6)
            toggle_site_status "$domain"
            ;;
        7)
            delete_site "$domain"
            ;;
        0)
            show_sites_dashboard
            ;;
        q|Q)
            echo -e "${GREEN}Cáº£m Æ¡n báº¡n Ä‘Ã£ sá»­ dá»¥ng WPST Panel!${NC}"
            exit 0
            ;;
        *)
            warning "Lá»±a chá»n khÃ´ng há»£p lá»‡."
            sleep 1
            show_single_site_dashboard "$domain"
            ;;
    esac
}

# Placeholder cho cÃ¡c dashboard khÃ¡c
show_firewall_dashboard() {
    clear
    show_header "Firewall / Security"
    echo "Chá»©c nÄƒng Ä‘ang phÃ¡t triá»ƒn..."
    echo ""
    read -p "Nháº¥n Enter Ä‘á»ƒ quay láº¡i..." 
    show_main_dashboard
}

show_update_dashboard() {
    clear
    show_header "Cáº­p Nháº­t"
    echo "Chá»©c nÄƒng Ä‘ang phÃ¡t triá»ƒn..."
    echo ""
    read -p "Nháº¥n Enter Ä‘á»ƒ quay láº¡i..."
    show_main_dashboard
}

show_admin_dashboard() {
    clear
    show_header "System Admin"
    echo "Chá»©c nÄƒng Ä‘ang phÃ¡t triá»ƒn..."
    echo ""
    read -p "Nháº¥n Enter Ä‘á»ƒ quay láº¡i..."
    show_main_dashboard
}

# Xá»­ lÃ½ tham sá»‘ dÃ²ng lá»‡nh
handle_arguments() {
    case $1 in
        "sites"|"1")
            CURRENT_MENU="sites"
            show_sites_dashboard
            ;;
        "firewall"|"2")
            CURRENT_MENU="firewall"
            show_firewall_dashboard
            ;;
        "update"|"3")
            CURRENT_MENU="update"
            show_update_dashboard
            ;;
        "admin"|"4")
            CURRENT_MENU="admin"
            show_admin_dashboard
            ;;
        "--help"|"-h")
            show_help
            ;;
        "--version"|"-v")
            show_version
            ;;
        "")
            show_main_dashboard
            ;;
        *)
            error "Tham sá»‘ khÃ´ng há»£p lá»‡: $1. Cháº¡y 'wpst --help' Ä‘á»ƒ xem hÆ°á»›ng dáº«n."
            ;;
    esac
}

# Hiá»ƒn thá»‹ help
show_help() {
    echo -e "${BLUE}WPST Panel - WordPress Stack Tool${NC}"
    echo ""
    echo "CÃ¡ch sá»­ dá»¥ng:"
    echo "  wpst                 Má»Ÿ dashboard chÃ­nh"
    echo "  wpst sites          Má»Ÿ quáº£n lÃ½ website"
    echo "  wpst firewall       Má»Ÿ quáº£n lÃ½ firewall"
    echo "  wpst update         Má»Ÿ menu cáº­p nháº­t"
    echo "  wpst admin          Má»Ÿ system admin"
    echo ""
    echo "TÃ¹y chá»n:"
    echo "  --help, -h          Hiá»ƒn thá»‹ hÆ°á»›ng dáº«n"
    echo "  --version, -v       Hiá»ƒn thá»‹ phiÃªn báº£n"
    echo ""
}

# Hiá»ƒn thá»‹ version
show_version() {
    echo "WPST Panel phiÃªn báº£n 1.0.0"
}

# Main function
main() {
    # Kiá»ƒm tra cÃ i Ä‘áº·t
    if [[ ! -d "$WPST_DIR" ]]; then
        error "WPST Panel chÆ°a Ä‘Æ°á»£c cÃ i Ä‘áº·t. Vui lÃ²ng cháº¡y script cÃ i Ä‘áº·t trÆ°á»›c."
    fi
    
    check_root
    
    # Khá»Ÿi táº¡o mÃ n hÃ¬nh
    init_screen
    
    # Xá»­ lÃ½ tham sá»‘
    handle_arguments "$1"
}

# Trap Ä‘á»ƒ cleanup khi exit
trap cleanup EXIT

# Cháº¡y main function
main "$@"
