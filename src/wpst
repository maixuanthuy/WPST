#!/bin/bash

# WPST Panel - WordPress Stack Tool
# PhiÃªn báº£n: 1.0.0

# ÄÆ°á»ng dáº«n cáº¥u hÃ¬nh
WPST_DIR="/var/www/wpst-script"
SITES_DIR="/var/www/sites"
CONFIG_DIR="$WPST_DIR/config"
LOG_DIR="$WPST_DIR/logs"

# MÃ u sáº¯c
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Load common functions náº¿u cÃ³
if [[ -f "$WPST_DIR/lib/common.sh" ]]; then
    source "$WPST_DIR/lib/common.sh"
fi

# Functions cÆ¡ báº£n náº¿u khÃ´ng cÃ³ common.sh
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[Lá»–I]${NC} $1"
    exit 1
}

warning() {
    echo -e "${YELLOW}[Cáº¢NH BÃO]${NC} $1"
}

info() {
    echo -e "${BLUE}[THÃ”NG TIN]${NC} $1"
}

success() {
    echo -e "${GREEN}[THÃ€NH CÃ”NG]${NC} $1"
}

# ASCII Logo
show_ascii_logo() {
    echo -e "${CYAN}"
    cat << 'EOF'
 _    _ _____   _____ _______   _____                 _ 
| |  | |  __ \ / ____|__   __| |  __ \               | |
| |  | | |__) | (___    | |    | |__) |_ _ _ __   ___ | |
| |/\| |  ___/ \___ \   | |    |  ___/ _` | '_ \ / _ \| |
\  /\  / |     ____) |  | |    | |  | (_| | | | |  __/| |
 \/  \/|_|    |_____/   |_|    |_|   \__,_|_| |_|\___||_|

WordPress Stack Tool - PhiÃªn báº£n 1.0.0
EOF
    echo -e "${NC}"
}

# System stats
show_quick_stats() {
    local hostname=$(hostname)
    local uptime=$(uptime -p 2>/dev/null || echo "Unknown")
    local load=$(uptime | awk -F'load average:' '{ print $2 }' | sed 's/^ *//' 2>/dev/null || echo "Unknown")
    
    echo -e "${CYAN}ğŸ–¥ï¸  Server: ${WHITE}$hostname${NC} | ${CYAN}â±ï¸  Uptime: ${WHITE}$uptime${NC}"
    echo -e "${CYAN}ğŸ“Š Load: ${WHITE}$load${NC}"
}

# Menu functions
show_sites_menu() {
    clear
    show_header "Quáº£n lÃ½ Website"
    
    local sites=()
    if [[ -d "$SITES_DIR" ]]; then
        for site_dir in "$SITES_DIR"/*; do
            if [[ -d "$site_dir" ]]; then
                sites+=($(basename "$site_dir"))
            fi
        done
    fi
    
    if [[ ${#sites[@]} -eq 0 ]]; then
        echo -e "${YELLOW}ChÆ°a cÃ³ website nÃ o Ä‘Æ°á»£c táº¡o.${NC}"
        echo ""
        echo "1. ThÃªm website má»›i"
        echo "0. Quay láº¡i"
        echo ""
        read -p "Lá»±a chá»n: " choice
        
        case $choice in
            1) add_new_site ;;
            0) show_main_menu ;;
            *) echo "Lá»±a chá»n khÃ´ng há»£p lá»‡."; sleep 1; show_sites_menu ;;
        esac
    else
        echo "Danh sÃ¡ch website:"
        for i in "${!sites[@]}"; do
            echo "$((i+1)). ${sites[i]}"
        done
        echo ""
        echo "0. Quay láº¡i"
        echo ""
        read -p "Chá»n website (0-${#sites[@]}): " choice
        
        if [[ "$choice" == "0" ]]; then
            show_main_menu
        elif [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le ${#sites[@]} ]]; then
            local selected_site="${sites[$((choice-1))]}"
            show_site_details_menu "$selected_site"
        else
            echo "Lá»±a chá»n khÃ´ng há»£p lá»‡."
            sleep 1
            show_sites_menu
        fi
    fi
}

show_site_details_menu() {
    local domain="$1"
    clear
    show_header "Website: $domain"
    
    echo "1. Xem thÃ´ng tin chi tiáº¿t"
    echo "2. Báº­t/Táº¯t website"
    echo "3. Chá»‰nh sá»­a cáº¥u hÃ¬nh"
    echo "4. Quáº£n lÃ½ database"
    echo "5. Backup & Restore"
    echo "6. XÃ³a website"
    echo "0. Quay láº¡i"
    echo ""
    read -p "Lá»±a chá»n: " choice
    
    case $choice in
        1) show_site_info "$domain" ;;
        2) toggle_site "$domain" ;;
        3) edit_site_config "$domain" ;;
        4) manage_site_database "$domain" ;;
        5) backup_site "$domain" ;;
        6) delete_site "$domain" ;;
        0) show_sites_menu ;;
        *) echo "Lá»±a chá»n khÃ´ng há»£p lá»‡."; sleep 1; show_site_details_menu "$domain" ;;
    esac
}

show_system_info() {
    clear
    show_header "ThÃ´ng tin Há»‡ thá»‘ng"
    
    echo "ğŸ–¥ï¸  Há»‡ Ä‘iá»u hÃ nh: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2 2>/dev/null || echo "Unknown")"
    echo "ğŸ’¾ RAM: $(free -h | awk 'NR==2{printf "%.1f/%.1f GB", $3/1024, $2/1024}')"
    echo "ğŸ’¿ Disk: $(df -h / | awk 'NR==2{print $3"/"$2" ("$5")"}')"
    echo "ğŸ”§ FrankenPHP: $(systemctl is-active frankenphp 2>/dev/null || echo "Unknown")"
    echo "ğŸ—ƒï¸  MariaDB: $(systemctl is-active mariadb 2>/dev/null || echo "Unknown")"
    echo ""
    echo "0. Quay láº¡i"
    echo ""
    read -p "Lá»±a chá»n: " choice
    
    case $choice in
        0) show_main_menu ;;
        *) echo "Lá»±a chá»n khÃ´ng há»£p lá»‡."; sleep 1; show_system_info ;;
    esac
}

show_config_menu() {
    clear
    show_header "CÃ i Ä‘áº·t & Cáº¥u hÃ¬nh"
    
    echo "1. Cáº¥u hÃ¬nh FrankenPHP"
    echo "2. Cáº¥u hÃ¬nh MariaDB"
    echo "3. Cáº¥u hÃ¬nh SSL"
    echo "4. Cáº¥u hÃ¬nh Firewall"
    echo "0. Quay láº¡i"
    echo ""
    read -p "Lá»±a chá»n: " choice
    
    case $choice in
        1) config_frankenphp ;;
        2) config_mariadb ;;
        3) config_ssl ;;
        4) config_firewall ;;
        0) show_main_menu ;;
        *) echo "Lá»±a chá»n khÃ´ng há»£p lá»‡."; sleep 1; show_config_menu ;;
    esac
}

show_backup_menu() {
    clear
    show_header "Backup & Restore"
    
    echo "1. Backup táº¥t cáº£ websites"
    echo "2. Backup website cá»¥ thá»ƒ"
    echo "3. Restore website"
    echo "4. Quáº£n lÃ½ backup"
    echo "0. Quay láº¡i"
    echo ""
    read -p "Lá»±a chá»n: " choice
    
    case $choice in
        1) backup_all_sites ;;
        2) backup_specific_site ;;
        3) restore_site ;;
        4) manage_backups ;;
        0) show_main_menu ;;
        *) echo "Lá»±a chá»n khÃ´ng há»£p lá»‡."; sleep 1; show_backup_menu ;;
    esac
}

show_logs_menu() {
    clear
    show_header "Logs & Monitoring"
    
    echo "1. Xem logs FrankenPHP"
    echo "2. Xem logs MariaDB"
    echo "3. Xem logs website"
    echo "4. Monitoring há»‡ thá»‘ng"
    echo "0. Quay láº¡i"
    echo ""
    read -p "Lá»±a chá»n: " choice
    
    case $choice in
        1) view_frankenphp_logs ;;
        2) view_mariadb_logs ;;
        3) view_website_logs ;;
        4) system_monitoring ;;
        0) show_main_menu ;;
        *) echo "Lá»±a chá»n khÃ´ng há»£p lá»‡."; sleep 1; show_logs_menu ;;
    esac
}

# Placeholder functions cho cÃ¡c tÃ­nh nÄƒng
add_new_site() {
    echo "ThÃªm website má»›i - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_sites_menu
}

show_site_info() {
    local domain="$1"
    echo "ThÃ´ng tin website $domain - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_site_details_menu "$domain"
}

toggle_site() {
    local domain="$1"
    echo "Báº­t/Táº¯t website $domain - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_site_details_menu "$domain"
}

edit_site_config() {
    local domain="$1"
    echo "Chá»‰nh sá»­a cáº¥u hÃ¬nh $domain - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_site_details_menu "$domain"
}

manage_site_database() {
    local domain="$1"
    echo "Quáº£n lÃ½ database $domain - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_site_details_menu "$domain"
}

backup_site() {
    local domain="$1"
    echo "Backup website $domain - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_site_details_menu "$domain"
}

delete_site() {
    local domain="$1"
    echo "XÃ³a website $domain - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_sites_menu
}

config_frankenphp() {
    echo "Cáº¥u hÃ¬nh FrankenPHP - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_config_menu
}

config_mariadb() {
    echo "Cáº¥u hÃ¬nh MariaDB - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_config_menu
}

config_ssl() {
    echo "Cáº¥u hÃ¬nh SSL - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_config_menu
}

config_firewall() {
    echo "Cáº¥u hÃ¬nh Firewall - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_config_menu
}

backup_all_sites() {
    echo "Backup táº¥t cáº£ websites - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_backup_menu
}

backup_specific_site() {
    echo "Backup website cá»¥ thá»ƒ - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_backup_menu
}

restore_site() {
    echo "Restore website - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_backup_menu
}

manage_backups() {
    echo "Quáº£n lÃ½ backup - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_backup_menu
}

view_frankenphp_logs() {
    echo "Xem logs FrankenPHP - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_logs_menu
}

view_mariadb_logs() {
    echo "Xem logs MariaDB - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_logs_menu
}

view_website_logs() {
    echo "Xem logs website - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_logs_menu
}

system_monitoring() {
    echo "Monitoring há»‡ thá»‘ng - Äang phÃ¡t triá»ƒn..."
    sleep 2
    show_logs_menu
}

# Header function
show_header() {
    local title="$1"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE} $title${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# Main menu
show_main_menu() {
    clear
    show_ascii_logo
    echo ""
    show_quick_stats
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "1. Quáº£n lÃ½ Website"
    echo "2. ThÃ´ng tin Há»‡ thá»‘ng"
    echo "3. CÃ i Ä‘áº·t & Cáº¥u hÃ¬nh"
    echo "4. Backup & Restore"
    echo "5. Logs & Monitoring"
    echo "0. ThoÃ¡t"
    echo ""
    read -p "Lá»±a chá»n: " choice
    
    case $choice in
        1) show_sites_menu ;;
        2) show_system_info ;;
        3) show_config_menu ;;
        4) show_backup_menu ;;
        5) show_logs_menu ;;
        0) echo "Táº¡m biá»‡t!"; exit 0 ;;
        *) echo "Lá»±a chá»n khÃ´ng há»£p lá»‡."; sleep 1; show_main_menu ;;
    esac
}

# Start the application
show_main_menu
