#!/bin/bash

# WPST Panel - Sites Management Functions
# Ch·ª©a c√°c functions ƒë·ªÉ qu·∫£n l√Ω websites

# Site listing and display functions
list_sites_table() {
    local sites=($(get_sites_list))
    
    if [[ ${#sites[@]} -eq 0 ]]; then
        echo -e "${YELLOW}Ch∆∞a c√≥ website n√†o ƒë∆∞·ª£c t·∫°o.${NC}"
        return
    fi
    
    # Table headers
    print_table_header "Domain" "Status" "Ping" "Backup" "Size" "Total"
    
    # Table rows
    for domain in "${sites[@]}"; do
        local status=$(get_site_status "$domain")
        local ping_status=$(check_site_ping "$domain")
        local backup_count=$(count_site_backups "$domain")
        local public_size=$(get_directory_size "$SITES_DIR/$domain/public")
        local total_size=$(get_directory_size "$SITES_DIR/$domain")
        
        # Format status
        local status_display
        if [[ "$status" == "online" ]]; then
            status_display="${GREEN}ON${NC}"
        else
            status_display="${RED}OFF${NC}"
        fi
        
        # Format ping
        local ping_display
        if [[ "$ping_status" == "success" ]]; then
            ping_display="${GREEN}‚úì${NC}"
        else
            ping_display="${RED}‚úó${NC}"
        fi
        
        print_table_row "$domain" "$status_display" "$ping_display" "$backup_count" "$public_size" "$total_size"
    done
    
    print_table_footer 6
}

# Site status functions
check_site_ping() {
    local domain="$1"
    local timeout=5
    
    # Ki·ªÉm tra HTTP/HTTPS
    if curl -s --max-time "$timeout" -I "https://$domain" >/dev/null 2>&1; then
        echo "success"
    elif curl -s --max-time "$timeout" -I "http://$domain" >/dev/null 2>&1; then
        echo "success"
    else
        echo "failed"
    fi
}

get_directory_size() {
    local dir="$1"
    
    if [[ -d "$dir" ]]; then
        local size_bytes=$(du -sb "$dir" 2>/dev/null | cut -f1)
        format_bytes "$size_bytes"
    else
        echo "0B"
    fi
}

count_site_backups() {
    local domain="$1"
    local backup_dir="$SITES_DIR/$domain/backup"
    
    if [[ -d "$backup_dir" ]]; then
        find "$backup_dir" -name "*.tar.gz" -type f 2>/dev/null | wc -l
    else
        echo "0"
    fi
}

# Site detail display
show_site_details() {
    local domain="$1"
    local site_dir="$SITES_DIR/$domain"
    
    if [[ ! -d "$site_dir" ]]; then
        error "Website $domain kh√¥ng t·ªìn t·∫°i."
        return 1
    fi
    
    # Ng√†y t·∫°o
    local created_date="N/A"
    if [[ -f "$site_dir/.created" ]]; then
        created_date=$(cat "$site_dir/.created")
    elif [[ -d "$site_dir" ]]; then
        created_date=$(stat -c %y "$site_dir" | cut -d' ' -f1)
    fi
    
    echo -e "üìÖ Ng√†y th√™m: ${GREEN}$created_date${NC}"
    echo -e "üåê Domain: ${GREEN}$domain${NC}"
    
    # SSL info
    local ssl_info=$(get_ssl_info "$domain")
    echo -e "üîí SSL: $ssl_info"
    
    # Storage info
    local public_size=$(get_directory_size "$site_dir/public")
    local total_size=$(get_directory_size "$site_dir")
    echo -e "üíæ Dung l∆∞·ª£ng: Public ${GREEN}$public_size${NC} / Total ${GREEN}$total_size${NC}"
    
    # Status
    local status=$(get_site_status "$domain")
    if [[ "$status" == "online" ]]; then
        echo -e "üî¥ Tr·∫°ng th√°i: ${GREEN}Online${NC}"
    else
        echo -e "üî¥ Tr·∫°ng th√°i: ${RED}Offline${NC}"
    fi
    
    # Database info
    local db_info=$(get_site_database_info "$domain")
    echo -e "üóÉÔ∏è  Database: $db_info"
}

get_ssl_info() {
    local domain="$1"
    
    # Ki·ªÉm tra custom SSL
    if [[ -f "$SITES_DIR/$domain/ssl/cert.pem" ]]; then
        local expiry=$(openssl x509 -in "$SITES_DIR/$domain/ssl/cert.pem" -noout -enddate 2>/dev/null | cut -d= -f2)
        if [[ -n "$expiry" ]]; then
            echo -e "${BLUE}Custom${NC} (H·∫øt h·∫°n: $expiry)"
        else
            echo -e "${YELLOW}Custom (Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c)${NC}"
        fi
    else
        # Ki·ªÉm tra Let's Encrypt
        local cert_path="/var/lib/caddy/.local/share/caddy/certificates/acme-v02.api.letsencrypt.org-directory/$domain"
        if [[ -f "$cert_path/$domain.crt" ]]; then
            local expiry=$(openssl x509 -in "$cert_path/$domain.crt" -noout -enddate 2>/dev/null | cut -d= -f2)
            if [[ -n "$expiry" ]]; then
                echo -e "${GREEN}Let's Encrypt${NC} (H·∫øt h·∫°n: $expiry)"
            else
                echo -e "${GREEN}Let's Encrypt${NC}"
            fi
        else
            echo -e "${YELLOW}Ch∆∞a c√≥ SSL${NC}"
        fi
    fi
}

get_site_database_info() {
    local domain="$1"
    local db_name=$(echo "$domain" | sed 's/\./_/g')_db
    
    if database_exists "$db_name"; then
        local db_size=$(get_database_size "$db_name")
        echo -e "${GREEN}$db_name${NC} ($db_size)"
    else
        echo -e "${RED}Ch∆∞a c√≥ database${NC}"
    fi
}

get_database_size() {
    local db_name="$1"
    load_db_config
    
    local size_bytes=$(mysql -u root -p"$DB_ROOT_PASSWORD" -e "
        SELECT ROUND(SUM(data_length + index_length), 1) AS 'DB Size in Bytes' 
        FROM information_schema.tables 
        WHERE table_schema='$db_name';" -s -N 2>/dev/null)
    
    if [[ -n "$size_bytes" && "$size_bytes" != "NULL" ]]; then
        format_bytes "$size_bytes"
    else
        echo "0B"
    fi
}

# Site creation functions
add_new_site() {
    clear
    show_header "Th√™m Website M·ªõi"
    
    # Nh·∫≠p domain
    local domain
    while true; do
        echo -e "\n${BLUE}Nh·∫≠p t√™n domain:${NC}"
        read -p "Domain: " domain
        domain=$(trim "$domain")
        
        # Validate domain format
        if ! validate_domain "$domain"; then
            warning "Domain kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p l·∫°i."
            continue
        fi
        
        # Ki·ªÉm tra tr√πng l·∫∑p
        if site_exists "$domain"; then
            warning "Domain $domain ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ch·ªçn domain kh√°c."
            continue
        fi
        
        break
    done
    
    # Ki·ªÉm tra DNS
    info "Ki·ªÉm tra DNS pointing..."
    local server_ip=$(get_server_ip)
    
    if ! check_dns_pointing "$domain" "$server_ip"; then
        show_warning_box "DNS Ch∆∞a Tr·ªè ƒê√∫ng" "Domain $domain ch∆∞a tr·ªè v·ªÅ IP $server_ip.\nN·∫øu s·ª≠ d·ª•ng Cloudflare, vui l√≤ng t·∫°m th·ªùi t·∫Øt Proxy.\nB·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c nh∆∞ng SSL c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông."
        
        if ! read_confirm "B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?" "n"; then
            return
        fi
    else
        success "Domain $domain ƒë√£ tr·ªè ƒë√∫ng v·ªÅ IP $server_ip"
    fi
    
    # Ki·ªÉm tra conflict th∆∞ m·ª•c
    if [[ -d "$SITES_DIR/$domain" ]]; then
        error "Th∆∞ m·ª•c $SITES_DIR/$domain ƒë√£ t·ªìn t·∫°i. Vui l√≤ng x√≥a trong Qu·∫£n l√Ω website tr∆∞·ªõc."
        return 1
    fi
    
    # X√°c nh·∫≠n t·∫°o database
    local create_database="y"
    echo -e "\n${BLUE}T·∫°o database cho website n√†y?${NC}"
    read -p "T·∫°o database [Y/n]: " create_db_input
    create_database=${create_db_input:-y}
    
    # X√°c nh·∫≠n c√†i WordPress
    local install_wordpress
    while true; do
        echo -e "\n${BLUE}C√†i ƒë·∫∑t WordPress?${NC}"
        read -p "C√†i WordPress [y/N]: " install_wordpress
        case "$install_wordpress" in
            [Yy]*) install_wordpress="y"; break ;;
            [Nn]*|"") install_wordpress="n"; break ;;
            *) warning "Vui l√≤ng nh·∫≠p y ho·∫∑c n." ;;
        esac
    done
    
    # B·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫°o site
    info "B·∫Øt ƒë·∫ßu t·∫°o website $domain..."
    
    # T·∫°o site v·ªõi rollback support
    if create_site_with_rollback "$domain" "$create_database" "$install_wordpress"; then
        show_site_creation_summary "$domain"
    else
        error "T·∫°o website th·∫•t b·∫°i."
    fi
}

create_site_with_rollback() {
    local domain="$1"
    local create_database="$2"
    local install_wordpress="$3"
    
    local rollback_steps=()
    
    # Step 1: T·∫°o th∆∞ m·ª•c
    info "T·∫°o c·∫•u tr√∫c th∆∞ m·ª•c..."
    local site_dir="$SITES_DIR/$domain"
    
    mkdir -p "$site_dir"/{public,ssl,backup,logs}
    rollback_steps+=("rm -rf $site_dir")
    
    # L∆∞u ng√†y t·∫°o
    date '+%Y-%m-%d %H:%M:%S' > "$site_dir/.created"
    
    # Step 2: T·∫°o database n·∫øu c·∫ßn
    local db_name=""
    local db_user=""
    local db_password=""
    
    if [[ "$create_database" == "y" ]]; then
        info "T·∫°o database..."
        
        db_name=$(echo "$domain" | sed 's/\./_/g')_db
        db_user=$(echo "$domain" | sed 's/\./_/g')_user
        db_password=$(generate_password 16)
        
        if ! create_site_database "$db_name" "$db_user" "$db_password"; then
            rollback_site_creation "${rollback_steps[@]}"
            return 1
        fi
        
        rollback_steps+=("drop_site_database $db_name $db_user")
    fi
    
    # Step 3: C√†i WordPress n·∫øu c·∫ßn
    if [[ "$install_wordpress" == "y" ]]; then
        info "T·∫£i v√† c√†i ƒë·∫∑t WordPress..."
        
        if ! install_wordpress_for_site "$domain" "$db_name" "$db_user" "$db_password"; then
            rollback_site_creation "${rollback_steps[@]}"
            return 1
        fi
    else
        # T·∫°o index.php ƒë∆°n gi·∫£n
        cat > "$site_dir/public/index.php" << EOF
<?php
echo "<h1>Website $domain</h1>";
echo "<p>Website ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!</p>";
echo "<p>B·∫°n c√≥ th·ªÉ upload code c·ªßa m√¨nh v√†o th∆∞ m·ª•c public.</p>";
?>
EOF
    fi
    
    # Step 4: T·∫°o Caddyfile
    info "T·∫°o c·∫•u h√¨nh Caddy..."
    
    if ! create_site_caddyfile "$domain"; then
        rollback_site_creation "${rollback_steps[@]}"
        return 1
    fi
    
    # Step 5: Reload FrankenPHP
    info "Kh·ªüi ƒë·ªông l·∫°i FrankenPHP..."
    
    if ! restart_service frankenphp; then
        rollback_site_creation "${rollback_steps[@]}"
        return 1
    fi
    
    # Set permissions
    chown -R frankenphp:frankenphp "$site_dir"
    chmod -R 755 "$site_dir"
    chmod -R 644 "$site_dir/public"
    
    success "Website $domain ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!"
    return 0
}

rollback_site_creation() {
    local steps=("$@")
    
    warning "ƒêang rollback do c√≥ l·ªói x·∫£y ra..."
    
    # Th·ª±c hi·ªán rollback theo th·ª© t·ª± ng∆∞·ª£c l·∫°i
    for ((i=${#steps[@]}-1; i>=0; i--)); do
        local step="${steps[i]}"
        info "Rollback: $step"
        
        if [[ "$step" == rm* ]]; then
            eval "$step" 2>/dev/null || true
        elif [[ "$step" == drop_site_database* ]]; then
            local args=($step)
            drop_site_database "${args[1]}" "${args[2]}"
        fi
    done
    
    warning "Rollback ho√†n th√†nh."
}

create_site_database() {
    local db_name="$1"
    local db_user="$2"
    local db_password="$3"
    
    load_db_config
    
    # T·∫°o database
    if ! mysql_query "CREATE DATABASE \`$db_name\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"; then
        error "Kh√¥ng th·ªÉ t·∫°o database $db_name"
        return 1
    fi
    
    # T·∫°o user
    if ! mysql_query "CREATE USER '$db_user'@'localhost' IDENTIFIED BY '$db_password';"; then
        error "Kh√¥ng th·ªÉ t·∫°o user $db_user"
        mysql_query "DROP DATABASE \`$db_name\`;" 2>/dev/null
        return 1
    fi
    
    # C·∫•p quy·ªÅn
    if ! mysql_query "GRANT ALL PRIVILEGES ON \`$db_name\`.* TO '$db_user'@'localhost';"; then
        error "Kh√¥ng th·ªÉ c·∫•p quy·ªÅn cho user $db_user"
        mysql_query "DROP USER '$db_user'@'localhost';" 2>/dev/null
        mysql_query "DROP DATABASE \`$db_name\`;" 2>/dev/null
        return 1
    fi
    
    mysql_query "FLUSH PRIVILEGES;"
    
    return 0
}

drop_site_database() {
    local db_name="$1"
    local db_user="$2"
    
    load_db_config
    
    mysql_query "DROP DATABASE IF EXISTS \`$db_name\`;" 2>/dev/null
    mysql_query "DROP USER IF EXISTS '$db_user'@'localhost';" 2>/dev/null
    mysql_query "FLUSH PRIVILEGES;" 2>/dev/null
}

install_wordpress_for_site() {
    local domain="$1"
    local db_name="$2"
    local db_user="$3"
    local db_password="$4"
    
    local site_dir="$SITES_DIR/$domain"
    local public_dir="$site_dir/public"
    
    # Download WordPress
    cd /tmp
    
    if ! wget -q https://wordpress.org/latest.tar.gz; then
        error "Kh√¥ng th·ªÉ t·∫£i WordPress"
        return 1
    fi
    
    # Extract
    if ! tar -xzf latest.tar.gz; then
        error "Kh√¥ng th·ªÉ gi·∫£i n√©n WordPress"
        rm -f latest.tar.gz
        return 1
    fi
    
    # Copy files
    cp -r wordpress/* "$public_dir/"
    rm -rf wordpress latest.tar.gz
    
    # T·∫°o wp-config.php
    if [[ -n "$db_name" ]]; then
        create_wp_config "$public_dir" "$db_name" "$db_user" "$db_password"
    fi
    
    return 0
}

create_wp_config() {
    local public_dir="$1"
    local db_name="$2"
    local db_user="$3"
    local db_password="$4"
    
    # Generate WordPress salts
    local salts=$(curl -s https://api.wordpress.org/secret-key/1.1/salt/)
    
    cat > "$public_dir/wp-config.php" << EOF
<?php
// ** Database settings ** //
define( 'DB_NAME', '$db_name' );
define( 'DB_USER', '$db_user' );
define( 'DB_PASSWORD', '$db_password' );
define( 'DB_HOST', '127.0.0.1' );
define( 'DB_CHARSET', 'utf8mb4' );
define( 'DB_COLLATE', '' );

// ** Authentication Unique Keys and Salts ** //
$salts

// ** WordPress Database Table prefix ** //
\$table_prefix = 'wp_';

// ** WordPress debugging mode ** //
define( 'WP_DEBUG', false );

// ** Security ** //
define( 'DISALLOW_FILE_EDIT', true );
define( 'AUTOMATIC_UPDATER_DISABLED', true );

// ** Absolute path to the WordPress directory ** //
if ( ! defined( 'ABSPATH' ) ) {
    define( 'ABSPATH', __DIR__ . '/' );
}

// ** Sets up WordPress vars and included files ** //
require_once ABSPATH . 'wp-settings.php';
EOF
}

create_site_caddyfile() {
    local domain="$1"
    local site_dir="$SITES_DIR/$domain"
    
    # Detect www vs non-www
    local main_domain="$domain"
    local redirect_domain=""
    
    if [[ "$domain" == www.* ]]; then
        redirect_domain="$domain"
        main_domain="${domain#www.}"
    else
        redirect_domain="www.$domain"
    fi
    
    cat > "$site_dir/Caddyfile" << EOF
# Auto-redirect www <-> non-www
$redirect_domain {
    redir https://$main_domain{uri} permanent
}

$main_domain {
    root * $site_dir/public
    encode zstd gzip
    php_server
    
    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        -Server
    }
    
    # Logging
    log {
        output file $site_dir/logs/access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
    }
    
    # WordPress specific rules
    @blocked {
        path *.txt *.log *.conf
        path /wp-admin/install.php
        path /wp-content/uploads/*.php
    }
    respond @blocked 403
}
EOF
    
    return 0
}

show_site_creation_summary() {
    local domain="$1"
    local site_dir="$SITES_DIR/$domain"
    
    echo ""
    show_success_box "Website T·∫°o Th√†nh C√¥ng!" "Website $domain ƒë√£ ƒë∆∞·ª£c t·∫°o v√† c·∫•u h√¨nh."
    
    echo -e "\n${BLUE}üìã TH√îNG TIN WEBSITE${NC}"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo -e "üåê Website: ${GREEN}https://$domain${NC}"
    echo -e "üìÅ Th∆∞ m·ª•c: ${GREEN}$site_dir${NC}"
    
    # Database info n·∫øu c√≥
    local db_name=$(echo "$domain" | sed 's/\./_/g')_db
    if database_exists "$db_name"; then
        local db_user=$(echo "$domain" | sed 's/\./_/g')_user
        
        echo ""
        echo -e "${BLUE}üóÉÔ∏è  TH√îNG TIN DATABASE${NC}"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo -e "Database: ${GREEN}$db_name${NC}"
        echo -e "User: ${GREEN}$db_user${NC}"
        
        # L∆∞u th√¥ng tin database
        if [[ -f "$CONFIG_DIR/mariadb_root.conf" ]]; then
            source "$CONFIG_DIR/mariadb_root.conf"
            local db_password=$(mysql -u root -p"$DB_ROOT_PASSWORD" -e "SELECT authentication_string FROM mysql.user WHERE User='$db_user' AND Host='localhost';" -s -N 2>/dev/null)
            if [[ -n "$db_password" ]]; then
                echo -e "Password: ${GREEN}ƒê√£ l∆∞u trong h·ªá th·ªëng${NC}"
            fi
        fi
    fi
    
    echo ""
    pause_for_input
}

# Site toggle functions
toggle_site_status() {
    local domain="$1"
    local current_status=$(get_site_status "$domain")
    
    if [[ "$current_status" == "online" ]]; then
        disable_site "$domain"
    else
        enable_site "$domain"
    fi
    
    restart_service frankenphp
    show_single_site_dashboard "$domain"
}

disable_site() {
    local domain="$1"
    local site_dir="$SITES_DIR/$domain"
    
    if [[ -f "$site_dir/Caddyfile" ]]; then
        mv "$site_dir/Caddyfile" "$site_dir/Caddyfile.disabled"
        success "Website $domain ƒë√£ ƒë∆∞·ª£c t·∫Øt."
    else
        warning "Website $domain ƒë√£ ƒë∆∞·ª£c t·∫Øt t·ª´ tr∆∞·ªõc."
    fi
}

enable_site() {
    local domain="$1"
    local site_dir="$SITES_DIR/$domain"
    
    if [[ -f "$site_dir/Caddyfile.disabled" ]]; then
        mv "$site_dir/Caddyfile.disabled" "$site_dir/Caddyfile"
        success "Website $domain ƒë√£ ƒë∆∞·ª£c b·∫≠t."
    else
        warning "Website $domain ƒë√£ ƒë∆∞·ª£c b·∫≠t t·ª´ tr∆∞·ªõc."
    fi
}

# Site deletion
delete_site() {
    local domain="$1"
    
    clear
    show_header "X√≥a Website: $domain"
    
    show_warning_box "C·∫¢NH B√ÅO" "B·∫°n s·∫Øp x√≥a ho√†n to√†n website $domain.\nT·∫•t c·∫£ d·ªØ li·ªáu bao g·ªìm files v√† database s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!"
    
    echo -e "\n${RED}ƒê·ªÉ x√°c nh·∫≠n, vui l√≤ng g√µ ch√≠nh x√°c t√™n domain:${NC}"
    read -p "Nh·∫≠p '$domain' ƒë·ªÉ x√°c nh·∫≠n: " confirm_domain
    
    if [[ "$confirm_domain" != "$domain" ]]; then
        warning "Domain kh√¥ng kh·ªõp. H·ªßy x√≥a website."
        sleep 2
        return
    fi
    
    if ! read_confirm "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a website $domain?" "n"; then
        info "ƒê√£ h·ªßy x√≥a website."
        sleep 1
        return
    fi
    
    # Th·ª±c hi·ªán x√≥a
    info "ƒêang x√≥a website $domain..."
    
    # X√≥a database
    local db_name=$(echo "$domain" | sed 's/\./_/g')_db
    local db_user=$(echo "$domain" | sed 's/\./_/g')_user
    
    if database_exists "$db_name"; then
        drop_site_database "$db_name" "$db_user"
        success "ƒê√£ x√≥a database $db_name"
    fi
    
    # X√≥a th∆∞ m·ª•c
    if [[ -d "$SITES_DIR/$domain" ]]; then
        rm -rf "$SITES_DIR/$domain"
        success "ƒê√£ x√≥a th∆∞ m·ª•c website"
    fi
    
    # Restart FrankenPHP
    restart_service frankenphp
    
    show_success_box "X√≥a Th√†nh C√¥ng" "Website $domain ƒë√£ ƒë∆∞·ª£c x√≥a ho√†n to√†n."
    
    pause_for_input
    show_sites_dashboard
}

# Placeholder functions cho c√°c t√≠nh nƒÉng s·∫Ω implement sau
edit_caddyfile() {
    local domain="$1"
    echo "Ch·ªânh s·ª≠a Caddyfile cho $domain - ƒëang ph√°t tri·ªÉn..."
    pause_for_input
    show_single_site_dashboard "$domain"
}

setup_custom_ssl() {
    local domain="$1"
    echo "C√†i ƒë·∫∑t SSL th·ªß c√¥ng cho $domain - ƒëang ph√°t tri·ªÉn..."
    pause_for_input
    show_single_site_dashboard "$domain"
}

open_file_manager() {
    local domain="$1"
    echo "File Manager cho $domain - ƒëang ph√°t tri·ªÉn..."
    pause_for_input
    show_single_site_dashboard "$domain"
}

manage_database() {
    local domain="$1"
    echo "Qu·∫£n l√Ω Database cho $domain - ƒëang ph√°t tri·ªÉn..."
    pause_for_input
    show_single_site_dashboard "$domain"
}

backup_restore_site() {
    local domain="$1"
    echo "Backup & Restore cho $domain - ƒëang ph√°t tri·ªÉn..."
    pause_for_input
    show_single_site_dashboard "$domain"
}

# Export functions
export -f list_sites_table check_site_ping get_directory_size count_site_backups
export -f show_site_details get_ssl_info get_site_database_info get_database_size
export -f add_new_site create_site_with_rollback rollback_site_creation
export -f create_site_database drop_site_database install_wordpress_for_site
export -f create_wp_config create_site_caddyfile show_site_creation_summary
export -f toggle_site_status disable_site enable_site delete_site
export -f edit_caddyfile setup_custom_ssl open_file_manager manage_database backup_restore_site
